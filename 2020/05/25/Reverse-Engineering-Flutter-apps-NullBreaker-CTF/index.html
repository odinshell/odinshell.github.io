<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="robots" content="index, follow"><title>Reverse Engineering Flutter apps: NullBreaker CTF • Asjid Kalam</title><meta name="description" content="Reverse Engineering Flutter apps: NullBreaker CTF - Asjid Kalam"><link rel="icon" href="/favicon.svg"><link rel="stylesheet" href="/css/nanoreset.min.css"><link rel="stylesheet" href="/css/theme.css"><link rel="search" type="application/opensearchdescription+xml" href="/atom.xml" title="Asjid Kalam"><meta name="theme-color" content="#222831"><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Asjid Kalam" type="application/atom+xml">
</head><body><div class="wrap" id="barba-wrapper"><header><h1 class="branding"><a href="/" title="Asjid Kalam">Asjid Kalam</a></h1><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link no-barba" href="/" target="_self">HOME</a></li><li class="nav-list-item"><a class="nav-list-link no-barba" href="/about" target="_self">ABOUT</a></li><li class="nav-list-item"><a class="nav-list-link no-barba" href="/archives" target="_self">ARCHIVES</a></li><li class="nav-list-item"><a class="nav-list-link no-barba" href="https://github.com/Asjidkalam" target="_blank">GITHUB</a></li></ul></header><div class="barba-container"><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Reverse Engineering Flutter apps: NullBreaker CTF</h1><div class="post-info"><a></a>Monday, May 25th 2020</div><div class="post-content"><p>We have a conducted a CTF recently - <a href="https://ctf.0xdeadbeef.games" target="_blank" rel="noopener">NullBreaker CTF</a> in association with <a href="https://ehackify.com/" target="_blank" rel="noopener">eHackify</a> and <a href="https://twitter.com/yetanothersec" target="_blank" rel="noopener">YAS</a>, and in this post, I’ll be discussing about reverse engineering one of the android challenge, <strong>TapTap</strong>. </p>
<p><em>Files:</em><br><a href="https://drive.google.com/file/d/1AiGME7lV9MCmIzmmOrx2FkO_Kbb8aUls" target="_blank" rel="noopener">Debug mode apk</a><br><a href="https://drive.google.com/file/d/1SNRg4jmh22L2s5KyHROmaLQ_yjPH1RQI" target="_blank" rel="noopener">arm64-v8 release</a><br><a href="https://drive.google.com/file/d/1eCuFJHGP2AHfUvtxrUgN0ffb1nt76vO7" target="_blank" rel="noopener">armeabi-v7a release</a></p>
<p><img src="/2020/05/25/Reverse-Engineering-Flutter-apps-NullBreaker-CTF/chall_popup.PNG" alt="Challenge"></p>
<h6 id="Flutter-Dart"><a href="#Flutter-Dart" class="headerlink" title="Flutter / Dart"></a>Flutter / Dart</h6><p>Flutter is Google’s framework for building natively-compiled applications for mobile, web and desktop from a single code base. It follows a “write once, run anywhere” design, so you could basically write the app once in dart, and use flutter to run it anywhere.</p>
<p>Dart is also created by Google, It is OOP language and has a syntax similar like java. Dart could compile in both Ahead Of Time (AOT) to native code like C/C++ and also to proprietary byte-code, to be later executed by some Just-In-Time(JIT) compiler like Java or JS.</p>
<h6 id="Challenge"><a href="#Challenge" class="headerlink" title="Challenge"></a>Challenge</h6><p>We provided a Debug-mode apk, which has a button and a counter which increases it’s value as we tap it.<br><img style="height: 700px; width: 400px;" src="/2020/05/25/Reverse-Engineering-Flutter-apps-NullBreaker-CTF/app.jpeg" alt="App" /></p>
<p>We can’t get the app source by just extracting like java compiled APKs. Flutter has this cool feature called “hot-reloading” which enables developers to change code in runtime, and only the new code that has been changed will be updated in the app, without the need to compile it again. DartVM takes care of all this work.</p>
<p>Hence, in debug mode apks, we can find the source code of the app including the comments made. All of the app code is present in the <code>kernel_blob.bin</code> in <code>/assets/flutter_assets/</code> directory of the decompressed APK.</p>
<p>Use <a href="https://ibotpeaches.github.io/Apktool/" target="_blank" rel="noopener">apktool</a> to extract the components of the apk.</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java <span class="literal">-jar</span> .\Tools\apktool_2.<span class="number">4.1</span>.jar d .\taptap<span class="literal">-debug</span>.apk</span><br></pre></td></tr></table></figure>
<p><img src="/2020/05/25/Reverse-Engineering-Flutter-apps-NullBreaker-CTF/apktool.PNG" alt="APKTool"> <img src="/2020/05/25/Reverse-Engineering-Flutter-apps-NullBreaker-CTF/kernel_blob.PNG" alt="Kernel_blob.bin"></p>
<p>Using strings you could extract the Dart code, but you’ll need to find the relevant code from the garbage strings.<br>Try to search strings like <code>Sup</code>, <code>NullBreaker CTF</code>, <code>main()</code> and other keywords which we already know from the APK.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strings kernel_blob.bin | grep <span class="string">"Sup?"</span> -m1 -B20 -A25</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/25/Reverse-Engineering-Flutter-apps-NullBreaker-CTF/strings_code.PNG" alt="main dart code from strings"></p>
<p>Here we could find the main class <code>MyHomePage</code> and the <code>_incrementCounter()</code> function which is called everytime the button is clicked. On looking closer at the <code>setState()</code> of <code>_incrementCounter()</code>, we could find an array named “secret” with some gibberish characters, followed by a little crypto to decode the flag. It’s only executed if the value of <code>_counter</code> goes above 850.</p>
<p>As we know the count of taps it takes to print the flag, we could possibly sent touch-events using ADB, if we’re too lazy to reverse the crypto. :D</p>
<p>We could use ADB to map out the counter button coordinate using the <code>getevent</code> command.<br><img src="/2020/05/25/Reverse-Engineering-Flutter-apps-NullBreaker-CTF/adb-getevent.gif" alt="ADB"><br>And then send touch events using <code>adb input tap</code>, 850 times.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">print(<span class="string">"[+] Sending touch event.."</span>)</span><br><span class="line">counter = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> counter != <span class="number">850</span>:</span><br><span class="line">        os.system(<span class="string">"adb.exe shell input tap 643 1191"</span>)</span><br><span class="line">        counter+=<span class="number">1</span></span><br><span class="line">        print(counter)</span><br></pre></td></tr></table></figure>
<p>But since this is a very time consuming task, we will reverse the encoding on the flag.</p>
<p>On looking closely on the decoding function, if the <code>_counter</code> goes above 850, it takes each element from the array and convert it into it’s respective ASCII code, add 1200 to it and performs a bitwise XOR with the whole number. It is then converted back to character and concatenated with the _flag variable.</p>
<p><img src="/2020/05/25/Reverse-Engineering-Flutter-apps-NullBreaker-CTF/decode_function.PNG" alt="decode function"></p>
<p>Python implementation:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">secret = [<span class="string">'\xa7'</span>, <span class="string">'\xab'</span>, <span class="string">'\xca'</span>, <span class="string">'\xbd'</span>, <span class="string">'\xcf'</span>, <span class="string">'\x92'</span>, <span class="string">']'</span>, <span class="string">'\xa7'</span>, <span class="string">'\xcd'</span>, <span class="string">'\x9b'</span>, <span class="string">'Y'</span>, <span class="string">'\xa0'</span>, <span class="string">'\xcd'</span>, <span class="string">'\xb6'</span>, <span class="string">'\xaf'</span>, <span class="string">'X'</span>, <span class="string">'\x9c'</span>, <span class="string">'^'</span>, <span class="string">'^'</span>, <span class="string">'Z'</span>, <span class="string">'\x9b'</span>, <span class="string">'\xb6'</span>, <span class="string">'\x9b'</span>, <span class="string">'Z'</span>, <span class="string">'\x9f'</span>, <span class="string">'Z'</span>, <span class="string">'\x9b'</span>, <span class="string">'\xba'</span>, <span class="string">'X'</span>, <span class="string">'\xa7'</span>, <span class="string">'\xce'</span>, <span class="string">'\x94'</span>]</span><br><span class="line">count = <span class="number">0</span></span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> secret:</span><br><span class="line">        flag = flag + chr((ord(secret[count]) + <span class="number">1200</span>) ^ <span class="number">1337</span>)</span><br><span class="line">        count +=<span class="number">1</span></span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>
<p>And we get the flag.</p>
<blockquote>
<p>nbCTF{4nDr0iD_f1u773r_r3v3rS1nG}</p>
</blockquote>
<p><strong>App source code:</strong> <a href="https://pastebin.com/V6BuXeWY" target="_blank" rel="noopener">main.dart</a><br><em>will be changed once the challenge repo goes public.</em></p>
</div></article></div></main><footer><div class="paginator"><a class="next" href="/2020/05/11/Attacking-MongoDB-s-ObjectID/">next</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'odinshell';
var disqus_identifier = '2020/05/25/Reverse-Engineering-Flutter-apps-NullBreaker-CTF/';
var disqus_title = 'Reverse Engineering Flutter apps: NullBreaker CTF';
var disqus_url = 'https://odinshell.github.io/2020/05/25/Reverse-Engineering-Flutter-apps-NullBreaker-CTF/';
(function () {
    var dsq = document.createElement('script'); dsq.async = true;
    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//odinshell.disqus.com/count.js" async></script><div class="copyright"><br>Made with ❤️ by <a href="https://twitter.com/odinshell" rel="noreferrer" target="_blank">Asjid Kalam</a></div></footer></div></div><script>var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-42903213-1']);
_gaq.push(['_trackPageview']);

(function () {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script><script src="https://cdnjs.cloudflare.com/ajax/libs/barba.js/1.0.0/barba.min.js"></script><script>document.addEventListener('DOMContentLoaded', function() {
    Barba.Pjax.start()
})</script></body></html>